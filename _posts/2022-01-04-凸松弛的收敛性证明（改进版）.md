---
layout: post
title: 列车节能运控优化中凸松弛收敛性证明——改进版
description: 在前面的文章中，我们尝试证明凸优化的松弛条件最后会在最优解的条件下最终收敛，也就是为了利用凸优化而引入的两个关键不等式约束最后会收敛为等式。但是，通过研究发现，我们的论证中存在一个明显的问题。这个问题出现的原因是因为我们尝试用一个基于单一电机效率的简单目标函数来代替带原本叫较为复杂的目标函数。
permalink: /blog/convex_4/
date: 2022-01-04
category: featured
tag:
- academic
- optimal train control
- constraints relaxation
- convex optimization
---

![Quadratic Function](/images/blog/relaxation_cvx_v2.png "Relaxation")

# 前言
在前面的[文一](http://lushaofeng.github.io/blog/convex_1)、[文二](http://lushaofeng.github.io/blog/convex_2)和[文三](http://lushaofeng.github.io/blog/convex_3)中，我们简单阐述了在列车运控优化问题中引入凸松弛后能够将可行域转为凸域和速度轨迹带来的形式化表达。我们还讨论了用归谬法来证明凸松弛对原问题的最优解没有影响，换言之，松弛虽然带来了可行域的变化，但是最优解并没有因为可行域的松弛而导致最优解变化，而且可以证明，当取得最优解的时候，松弛后的不等式必须严格取等号。

不过通过仔细研究发现，[文三](http://lushaofeng.github.io/blog/convex_3)的证明存在一个明显的瑕疵，该明显瑕疵来自于我们将列车在再生制动和牵引过程的电机效率等同于1，目标函数值由$$\sum_i F_i\Delta d_i$$来替代。但是当电机的运行效率不为1的时候，简化版的目标函数并不等于原本的目标函数。因此[文三](http://lushaofeng.github.io/blog/convex_3)的证明只能在非常理想的条件下成立。为了解决这个问题，本文将着重探讨如何在通常条件下来证明凸松弛条件最终会收敛于等号——模型中的凸松弛为绝对松弛（Relaxation is exact）。

为了方便陈述，我们做如下定义。
* **边界能量：**由能量守恒方程式$$F_i\Delta d=0.5M(\beta_i-\beta_{i-1})+f_i\Delta d+Mg\Delta H_i$$决定的正负能量值。理论上，边界能量的的大小由能量守恒方程和电机特性共同决定。为了简化说明，我们假定能量守恒方程式包含了电机特性，也即电机的牵引力和再生制动力能够满足所有运行条件，不需要额外借助空气制动等机械制动。 当边界能量为正，电机做正功；当边界能量为负，电机做负功。
* **正负边界能量集：**$$E_i^{+}\in E^{+}$$, $$E_i^-\in E^-$$,其中$$i=1,..., N \in \mathbb{I}$$。模型中N为列车运行路程所分的段数。$$E_i^+>=0$$为某一区间中有当前的速度点决定的正边界能量；同理，$$E_i^-<=0$$为负边界能量。$$E_i^+*E_i^-=0$$，这个约束用来表示，每个区间之多只有一个边界能量为非零。
* **净能耗：**用来表示我们的目标函数$$\sum_i(E_i^{+} \eta_t^{'}+ E_i^{-} \eta_b)$$。其中$$\eta_t^{'}=1/\eta_t\geq 1$$为列车牵引效率的倒数,$$0\geq \eta_b\geq 0$$为列车的再生制动效率。
* $$j\in \mathbb{K}$$和$$k\in \mathbb{J}$$分别用来表示正负边界能量集合中的非零项的编号，有$$\mathbb{K}\cup \mathbb{J}= \mathbb{I}$$
* **距离区间：**列车运行的路程被分为N个区间，每个区间被成为一个距离区间，每个距离区间对应一个固定的限速和坡度等。
* **计算区间：**和每个距离区间一一对应。在建模过程中，引入的虚拟概念。列车运行的区间根据距离被分为总数为N的计算区间，每个计算区间内需要分别建立一组运行约束条件。

基于以上定义，我们给出如式\eqref{eq:obj_fun}所示的目标函数的特殊表达，我们将边界负能量拆分为两项，分别为即$$\eta_t^{'}E_i^-$$和$$(\eta_b-\eta_t^{'})E_i^+$$。前项与边界负能量进行合并，构建为$$F_i\Delta d$$的求和，如[文三](http://lushaofeng.github.io/blog/convex_3)所示，该求和可以表示为：$$\sum_i F_i\Delta d_i\\=0.5M(v_t^2-v_0^2)+\sum_i f_i\Delta d+Mg\Delta H\\=B\sum_i v_{ave,i}\Delta d+ C \sum_i \beta_i\Delta d+Mg\Delta H+0.5M(v_t^2-v_0^2) +NA$$。在本文中，我们将这两项定义为目标前项，剩余的边界负能量的求和项则被定义为目标后向。

$$
\begin{align}
\label{eq:obj_fun}
\sum_i (E_i^+\eta_t^{'}+E_i^-\eta_b)\\
&=\sum_i(\eta_t^{'}(E_i^+ + E_i^-)+(\eta_b-\eta_t^{'})E_i^-)\\
&=\eta_i \sum_i F_i \Delta d+ (\eta_b-\eta_t^{'}) sum_k(0.5M(\beta_{k} -\beta_{k-1})+(A+B v_{ave,k}+C\beta_k)\Delta d+Mg\Delta H_k)
\end{align}
$$

# 两组列车最优控制模型
![Optimal Train Control Based on Convexification](/images/blog/convexification.png "Optimal Train Control Based on Convexification")
图中展示了凸优化松弛前后的两组建模方法。松弛后，我们在时间计算和阻力计算中引入了两组凸松弛变量$$\alpha_i$$和$$\beta_i$$。在[文三](http://lushaofeng.github.io/blog/convex_3)的证明中，我们采用一种基于微小扰动的归谬法，为了证明最优解在等式中会收敛，我们先假设最优解存在于严格不等式条件下，一定有一个可行解能够得到比该最优解更优的解，这样就自动推翻了前面的假设————最优解存在于严格不等式条件下。本文中，我们尝试另外一种相似的思路，就是当在松弛条件的等式约束中引入一个足够小的扰动$$\epsilon>0$$，使不等式变为一个严格的不等式（注：严格不等式即不含有等号的不等式:“<”或者“>”）。这个时候，如果能够看到目标函数因该微小的扰动而增加，则可证明等式成立是局部最优的必要条件。又由于该问题为凸优化问题，因此等式成立是全局最优的必要条件————也即当得到优化结果的时候，等式成立。两种证明方式是等价的，只是引入的微小扰动的使用方法不完全一样。

# 关于松弛约束$$1\leq v_{ave,i} \alpha_i$$收敛性证明
证明：当在不等式中，引入微小扰动$$\epsilon>0$$,使得$$(v_{ave,i}^{'}=v_{ave,i}+\epsilon)$$，则有$$1<v_{ave,i}^{'}\alpha_i$$。此时我们需要看到，当微小扰动$$\epsilon$$引入时，目标函数会发生什么变化。

下面，我们分两种情况讨论：
* **情况一**：当$v_{ave,i}$的编号$$i\notin K$$，该区间对应的边界能量为正，因此在区间i上，目标函数不存在$$(\eta_b-\eta_t^{'})E_i^+$$这一项。可以很明显看到，当$v_{ave,i}$有一个微小增加之后，通过考虑目标函数中和其相关的项，目标函数的值将增加$$\eta_t B\Delta d\epsilon>0$$。
* **情况二**：当$v_{ave,i}$的编号$$i\in K$$，该区间对应的边界能量为负。这个时候，需要同时考虑目标函数中的目标前项和后项。通过合并目标函数的同类项，我们可以计算出由$$\epsilon$$得到的目标函数的增量为：$$\eta_t B\epsilon\Delta d +(\eta_b-\eta_t^{'})B\epsilon\Delta d=B\epsilon \eta_b>0$$，可见，目标函数的增量为正。

通过以上两种情况的探讨，可以看到当引入一个正微小扰动$$\epsilon$$，使得原有的松弛不等式$$1\leq v_ave,i \alpha_i$$成为一个严格不等式的时候，目标函数的函数值均上升。该松弛约束的等式条件为目标函数最优的必要条件。问题得证。

# 关于松弛约束$$v_i^2 \leq \beta_i$$的收敛性证明
和前述证明方式类似，我们需要引入一个微小扰动造成松弛约束从非严格不等式编程严格不等式。下面我们将根据目标后项中和$$beta_i$$相关的项进行分类讨论。可以看到，这个两个相关的项分别由下式\eqref{eq:beta_eqns}中的$$\beta_2$$和 $$g_2(\beta_i)$$来表示。

$$
\begin{align}
\label{eq:beta_eqns}
g_1{beta_i}&=0.5M(\beta_i-\beta_{i-1})+(A+B v_{ave,i}+C\beta_i)\Delta d+ Mg\Delta H_i\\
g_2(beta_i)&=0.5M(\beta_{i-1}-\beta_i)+(A+B v_{ave,i+1}+C\beta_i+1)\Delta d+ Mg\Delta H_{i+1}
\end{align}
$$

## 条件一：$$g_1(\beta_i)$$和 $$g_2(\beta_i)$$同时为负
当此条件一下，在$$\beta_i$$引入一个微小正扰动$$\epsilon>0$$，严格不等式条件成立。这时候目标函数的增量由下式\eqref{eq:beta_case_1}表示。
$$
\begin{align}
\label{eq:beta_case_1}
\delta C\epsilon \Delta d\eta_t + (\eta_b-\eta_t^{'})(0.5 M\epsilon +C\epsilon\Delta d)\\
+(\eta_b-\eta_t)(-0.5M\epsilon)\\
=C\epsilon \Delta d \eta_t^{'}+(\eta_b-\eta_t^{'})(C\Delta \epsilon \Delta d)\\
=C\epsilon\Delta d\eta_b>0
\end{align}
$$

可见，在条件一下，在$$\beta_i$$中引入微小增量，可带来目标函数的增加。
## 条件二： $$g_1(\beta_i)\geq 0$$和 $$g_2(\beta_i)\leq 0$$

在此条件二下，在$$\beta_i$$引入一个微小正扰动$$\epsilon>0$$，这时候目标函数的增量由式\eqref{eq:beta_case_2}表示。
$$
\begin{align}
\label{eq:beta_case_2}
\delta C\epsilon \Delta d\eta_t - (\eta_b-\eta_t^{'})(0.5 M\epsilon \epsilon )>0\\
\end{align}
$$

式\eqref{eq:beta_case_2}的前面一项为正，而后面一项也为正，可见目标函数的增量为正。可见在条件二下，微小的扰动，带来目标函数值的上升。

## 条件三： $$g_1(\beta_i)\leq 0$$和 $$g_2(\beta_i)\geq 0$$
类似的，在条件三下，引入一个微小扰动，计算目标函数值的变化，该变化由式\eqref{eq:beta_case_3}表示。
$$
\begin{align}
\label{eq:beta_case_3}
\delta C\epsilon \Delta d\eta_t + (\eta_b-\eta_t^{'})(0.5 M\epsilon +C \epsilon \Delta d)\\
=\eta_b C\epsilon \Delta d+ (\eta_b-\eta_t^{'})(0.5 M\epsilon)
\end{align}
$$

这个时候可以发现，由于戴维斯常数C相对于列车质量M较小，$$\eta_b C\Delta d<0.5(\eta_t^{'}-\eta_b)M$$。因此，引入一个正的扰动，将导致目标函数的增加。我们需要注意到，此时的$$beta_i$$并没有在最优解的必要条件上，继续增加$$\beta_i$$将带来目标函数的下降，直到达到$$\beta_i$$的边界。要证明这个结论，可以只需要证明$$beta_i$$的增加，会带来目标函数的下降即可。

下面我们可以考虑$$\beta_i$$到达边界条件之后$$\beta_i$$的情况会如何。根据条件三，可分别算出以下两个关系式。

依据$$g_1(\beta_i)\leq 0$$,可以得到：

$$
\begin{align}
\label{eq:beta_ul_1}
&0.5M（\beta_i-\beta_{i-1}）+(A+Bv_{ave,i}+C\beta_i)\Delta d+Mg\Delta H_i \leq 0\\
&(0.5M+C\Delta d)\beta_i \leq 0.5\beta_{i-1}-(A+Bv_{ave,i})\Delta d-Mg\Delta H_i\\
&\beta_i \leq \frac{0.5\beta_{i-1}-(A+Bv_{ave,i})\Delta d-Mg\Delta H_i}{0.5M+C\Delta d}
\end{align}
$$

类似地，可得到：

$$
\begin{align}
\label{eq:beta_ul_2}
0.5M\beta_i &\leq 0.5M\beta_{i+1}+(A+Bv_{ave,i}+C\beta_{i+1})\Delta d+Mg\Delta H_i\\
\beta_i &\leq \frac{0.5M\beta_{i+1}+(A+Bv_{ave,i}+C\beta_{i+1})\Delta d+Mg\Delta H_i}{0.5M}
\end{align}
$$

另外，根据限速要求，$$\beta_i\leq v_{lim,i}^2$$。以上三式分别决定了$$\beta_i$$的三个上界。之前的观察到$$beta_i$$必须增加到三个上界。也只有达到前两个上界，才有可能得到最优解的必要条件。下面，我们讨论当$$beta_i$$到达由式\eqref{eq:beta_ul_1}和式\eqref{eq:beta_ul_2}带来的上界的时候，会出现什么情况。
* 当式\eqref{eq:beta_ul_1}变为等式，那么目标函数中和$$\beta_i$$的相关目标后项，均为非负项，和$$beta_i$$相关的项，仅存在于目标前项。前面已经论述，在此条件下$$beta_i$$的正扰动将带来目标函数的上升。
* 当式\eqref{eq:beta_ul_1}变为等式，目标函数将变为和条件一的情况一致，而条件一的时候，$$beta_i$$的正扰动将带来目标函数的上升。

可见，当达到前两个上界的$$\beta_i$$，将实现一个微小的正扰动带来目标函数的上升。换言之，条件三最终会在边界上被转换为某一个最优解的必要条件，然后在这一条件下，可以看到松弛约束将会严格收敛在等号上。

最后讨论当$$beta_i=v_{lim,i}$$的情况。注意到当前$$\beta_i$$为常数，而原来的松弛约束$$v_i^2\leq \beta_i$$成为了限速的常规约束，换而言之，该松弛约束不复存在。因此在这个时候似乎不再需要证明是否有松弛约束收敛的问题，原因是约束在这个时候完全被另外一个常规线速约束替代而消失了。套用列车最优运控的术语，当列车接近限速时候，会出现最优控制策略的跃迁，这个时候属于控制策略的“奇点（Singularity）”。当出现$$\beta_i=v_{lim,i}$$的时候，是否也能认为这个解对应了列车运行的奇点，这个时候之前讨论的所有扰动法都失效了。如果在这个时候用经典扰动法来证明，将无法得到速度会贴近限速，也即“v_i^2”和“\beta_i”无法证明必须贴合。

# 小结
以上的分析尝试在更加通常的条件下证明所提出的凸松弛变量将在最优化过程中被严格收敛到等式上。和[文三](http://lushaofeng.github.io/blog/convex_3)不同，本文讨论了在牵引电机效率在0到1之间变化的时候的通常情况。除了在$$\beta_i=v_{lim,i}$$的条件下，我们无法用扰动法得到目标函数会随着轻微扰动而上升的情况，其他情况均可以实现这一构想。而轻微扰动带来目标函数的上升，这将说明收敛不等式取等号是凸优化模型取得最优解的必要条件。用扰动法证明在取松弛约束取等号的时候，该条件满足局部最优的要求，属于局部最优解的必要条件，进而证明凸优化模型取得最优解的时候，松弛约束的等式条件成立。
